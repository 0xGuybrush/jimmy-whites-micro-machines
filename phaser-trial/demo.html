<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('checkpoint', 'assets/star.png');
    game.load.image('car', 'assets/car.png');
}

var playerOne;
var playerTwo;

var cursors;
var wasd;

var checkpoints;
var score = 0;
var scoreText;
var milliseconds = 0;
var seconds = 0;
var minutes = 0;
var timerText = "";
var gameStarted = 0;
var halfSecondCounter = 0;
var playerOneSpeed = 0;
var playerOneTurningSpeed = 5;
var playerTwoSpeed = 0;
var playerTwoTurningSpeed = 5;

var MAX_SPEED = 80;
var MAX_REVERSE = -30;//(MAX_SPEED * 0.375); //Just felt about right
var RATE_OF_ACCELERATION = 1;
var RATE_OF_DECELERATION = 3;

var nextCheckpoint = 0;

function createCheckpoint(checkpoints, x, y) {
	var checkpoint = checkpoints.create(x, y, 'checkpoint');
}

function create() {
	gameStarted = game.time.now;
    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.world.setBounds(0, 0, 2000, 600);

    //  A simple background for our game
 	 game.add.sprite(0, 0, 'sky');

    players = game.add.group();
    
    // The playerOne and its settings
    playerOne = players.create(32, game.world.height - 150, 'car');
    playerOne.name = 'spider';
  //  playerTwo = players.create(80, game.world.height - 150, 'car');
   // playerTwo.name = 'walter';	
        
	playerOne.anchor.setTo(0.5, 0.5);
    //  We need to enable physics on the playerOne
    game.physics.arcade.enable(playerOne);


//	playerTwo.anchor.setTo(0.5, 0.5);
    //  We need to enable physics on the playerOne
 //   game.physics.arcade.enable(playerTwo);

    //  Player physics properties. Give the little guy a slight bounce.
//   	playerOne.body.bounce.y = 0;
 //   playerOne.body.gravity.y = 0;
    playerOne.body.collideWorldBounds = true;
    
  /*  playerTwo.body.bounce.y = 0;
    playerTwo.body.gravity.y = 0;
    playerTwo.body.collideWorldBounds = false;

    //  Finally some checkpoints to collect
	 checkpoints = game.add.group();

    //  We will enable physics for any checkpoint that is created in this group
    checkpoints.enableBody = true;
	createCheckpoint(checkpoints, 100, 100);
	createCheckpoint(checkpoints, 1900, 100);
	createCheckpoint(checkpoints, 1900, 500);	
	createCheckpoint(checkpoints, 100, 500);
	//  Let gravity do its thing


    scoreText = game.add.text(684, 16, 'Lap: 0', { fontSize: '32px', fill: '#000' });
    timerText = game.add.text(16, 16, '00:00:00', { fontSize: '32px', fill: '#000' });
    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys(); 
	wasd = {
		up: game.input.keyboard.addKey(Phaser.Keyboard.W),
		down: game.input.keyboard.addKey(Phaser.Keyboard.S),
		left: game.input.keyboard.addKey(Phaser.Keyboard.A),
		right: game.input.keyboard.addKey(Phaser.Keyboard.D)
    };*/
    
    playerOne.body.velocity.x = 0;
    playerOne.body.velocity.y = 0;
    playerOne.body.angularVelocity = 0;
    	
    game.add.tween(playerOne).to({x: 100, y: 100}, 
    	1000 /*duration of the tween (in ms)*/, 
	    Phaser.Easing.Linear.None /*easing type*/, 
	    true /*autostart?*/, 
0 /*delay*/, 
    	true /*yoyo?*/).start(2000);
    	playerOne.body.velocity.x = 0;
    	playerOne.body.velocity.y = 0;
    	playerOne.body.angularVelocity = 0;
}

function updateTimer() {
 	
 	var elapsed = game.time.elapsedSince(gameStarted)
    minutes = Math.floor(elapsed / 60000) % 60;
    seconds = Math.floor(elapsed / 1000) % 60;
    milliseconds = Math.floor(elapsed) % 100;
 
    //If any of the digits becomes a single digit number, pad it with a zero
    if (milliseconds < 10)
        milliseconds = '0' + milliseconds;
 
    if (seconds < 10)
        seconds = '0' + seconds;
 
    if (minutes < 10)
        minutes = '0' + minutes;
 
    timerText.setText(minutes + ":"+ seconds + ":" + milliseconds);
 }

function blinkTimer() {
	if (halfSecondCounter >= 500) {
		halfSecondCounter -= 500;
		timerText.visible = !timerText.visible;
	}
}

function distanceBetweenTwoElements(elementA, elementB) {
	return (elementA.x - elementB.x) + (elementA.y - elementB.y);
}

function playerInTheLead() {
	var nextCheckpointElement = checkpoints.getAt(nextCheckpoint);
	var distanceFromPlayerOneToCheckpoint = distanceBetweenTwoElements(nextCheckpointElement, playerOne);
	var distanceFromPlayerTwoToCheckpoint = distanceBetweenTwoElements(nextCheckpointElement, playerTwo);
	
	if (distanceFromPlayerOneToCheckpoint < distanceFromPlayerTwoToCheckpoint) {
		return playerOne;
	} else {
		return playerTwo;
	}
}


function update() {}
/*
		var yellowShirt = playerInTheLead();
		/*if (game.camera.target != yellowShirt) {
			game.add.tween(game.camera).to( {x: yellowShirt.x, y: yellowShirt.y}, 30, Phaser.Easing.Quadratic.InOut, true);		
		} else {*/
			game.camera.focusOn(yellowShirt);
	//	}
/*
		if(!playerOne.inCamera && !game.pause && playerTwo == yellowShirt) {
	/*		game.pause = true;
			playerOne.x = playerTwo.x;
			playerOne.y = playerTwo.y;
			var pointLabel = this.add.text(game.camera.width / 2, game.camera.height / 2, "Point to " + playerTwo.name + "!", 
			{font: "10px Arial", fill: "#ffffff", stroke: '#000000', strokeThickness: 2});
		 /*   var tween = this.add.tween(pointLabel).delay(100).to({y: pointLabel.y-100}, 1000, Phaser.Easing.Linear.None).start();
		    tween.onComplete.add(function() {
				pointLabel.destroy();
			}, this); */
			//game.add.tween(playerTwo).to({x: (game.camera.x + game.camera.width / 2), y: (game.camera.y + game.camera.height / 2)}, 30, Phaser.Easing.Quadratic.InOut, true);
		//	game.add.tween(playerOne).to({x: playerTwo.x, y: playerTwo.y + 16}, 30, Phaser.Easing.Quadratic.InOut, true);
			
			//playerOne.kill();
/*			pointLabel.destroy();
			game.pause = false; */
	//	}
		/*
		if(!playerTwo.inCamera && !game.pause && playerOne == yellowShirt) {
	/*		game.pause = true;
			playerTwo.x = playerOne.x;
			playerTwo.y = playerOne.y;
			var pointLabel = this.add.text(game.camera.width / 2, game.camera.height / 2, "Point to " + playerOne.name + "!", 
			{font: "10px Arial", fill: "#ffffff", stroke: '#000000', strokeThickness: 2});
/*		    var tween = this.add.tween(pointLabel).delay(100).to({y: pointLabel.y-100}, 1000, Phaser.Easing.Linear.None).start();
		    tween.onComplete.add(function() {
				pointLabel.destroy();
			}, this); */
			//game.add.tween(playerTwo).to({x: (game.camera.x + game.camera.width / 2), y: (game.camera.y + game.camera.height / 2)}, 30, Phaser.Easing.Quadratic.InOut, true);
//			game.add.tween(playerTwo).to({x: playerOne.x, y: playerOne.y + 16}, 30, Phaser.Easing.Quadratic.InOut, true);
		//	pointLabel.destroy();		
			//playerOne.kill();
		//	game.pause = false; */
/*		}
	
	
		halfSecondCounter += game.time.elapsed;
		if (checkpoints.countLiving() > 0) {
			updateTimer();
		} else {
			if (score >= 3) { 
				blinkTimer();
			} else {
				createCheckpoint(checkpoints, 100, 100);
				createCheckpoint(checkpoints, 1900, 100);
				createCheckpoint(checkpoints, 1900, 500);	
				createCheckpoint(checkpoints, 100, 500);
			
				score += 1;
				scoreText.text = 'Lap: ' + score;
			}
		}
	
	
		//  Checks to see if the playerOne overlaps with any of the checkpoints, if he does call the collectCheckpoint function
		game.physics.arcade.overlap(playerOne, checkpoints, collectCheckpoint, null, this);
		game.physics.arcade.overlap(playerTwo, checkpoints, collectCheckpoint, null, this);
	
		//  Reset the playerOnes velocity (movement)
		
		drive(playerOne);
		playerTwo.body.angularVelocity = 0;
		playerTwo.body.velocity.y = 0;
		playerTwo.body.velocity.x = 0;	
		var angle = playerTwo.angle;
		var radians = (Math.PI / 180) * ( angle - 90 ); 
		
		if (angle == 0 ) {
			angle = 1;
		} else if (angle < 0) {
			angle += 360;
		}
		
		if(wasd.up.isDown) {	
			if (playerTwoSpeed < MAX_SPEED && !cursors.down.isDown) {
				playerTwoSpeed += RATE_OF_ACCELERATION;
			}
		}
		
		if (wasd.down.isDown) {
			if (playerTwoSpeed > MAX_REVERSE) {	
				playerTwoSpeed--;
			}
		} 
		
		if (wasd.down.isUp && wasd.up.isUp) {
			if (playerTwoSpeed > 0) {
				playerTwoSpeed -= RATE_OF_DECELERATION;
			} 
			
			if (playerTwoSpeed < 0) {
				playerTwoSpeed += RATE_OF_ACCELERATION;
			}
		} 
		
		
		if (wasd.left.isDown) {
			playerTwo.angle -= playerTwoTurningSpeed;
		}
		
		if (wasd.right.isDown) {
			playerTwo.angle += playerTwoTurningSpeed;
		}
	
	   
		playerTwo.body.x = playerTwo.body.x + playerTwoSpeed/10 * Math.cos(radians);
		playerTwo.body.y = playerTwo.body.y + playerTwoSpeed/10 * Math.sin(radians);
		*/
//}





function drive(playerOne) {
	playerOne.body.angularVelocity = 0;
    playerOne.body.velocity.y = 0;
    playerOne.body.velocity.x = 0;	
	var angle = playerOne.angle;
    var radians = (Math.PI / 180) * ( angle - 90 ); 
    
    if (angle == 0 ) {
    	angle = 1;
    } else if (angle < 0) {
    	angle += 360;
    }
    
    if(cursors.up.isDown) {	
    	if (playerOneSpeed < MAX_SPEED && !cursors.down.isDown) {
    		playerOneSpeed += RATE_OF_ACCELERATION;
    	}
    }
    
    if (cursors.down.isDown) {
    	if (playerOneSpeed > MAX_REVERSE) {	
    		playerOneSpeed--;
    	}
    } 
    
    if (cursors.down.isUp && cursors.up.isUp) {
    	if (playerOneSpeed > 0) {
    		playerOneSpeed -= RATE_OF_DECELERATION;
    	} 
    	
    	if (playerOneSpeed < 0) {
    		playerOneSpeed += RATE_OF_ACCELERATION;
    	}
    } 
    
    
    if (cursors.left.isDown) {
        playerOne.angle -= playerOneTurningSpeed;
    }
    
    if (cursors.right.isDown) {
        playerOne.angle += playerOneTurningSpeed;
    }

   
    playerOne.body.x = playerOne.body.x + playerOneSpeed/10 * Math.cos(radians);
  	playerOne.body.y = playerOne.body.y + playerOneSpeed/10 * Math.sin(radians);
}

function collectCheckpoint (playerOne, checkpoint) {
	if(checkpoint == checkpoints.getAt(nextCheckpoint)) {
    	checkpoint.kill();   
	    nextCheckpoint++;
	}
}
</script>

</body>
</html>